<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Service Charts – IB Nueva Esperanza RVA</title>

<!-- ✅ Reuse your existing styles -->
<link rel="stylesheet" href="../shared/chart-styles.css" />

<style>
/* ===============================
   SERVICE VIEW OVERRIDES ONLY
   =============================== */

body {
  background:#fff;
}

header,
footer {
  display:none;
}

/* Lock UI */
.controls,
.editor-only,
#keySelect,
#shareLink,
#shareViewerBtn,
#downloadCho,
#chordLegend,
#showChordsToggle,
#chordViewSelect {
  display:none !important;
}

/* Service container */
#serviceOutput {
  max-width:900px;
  margin:0 auto;
}

/* Song separation */
.song-start {
  column-span: all;
  break-inside: avoid;
  margin: 20px 0 12px;
}

/* Print: one song per page */
@media print {
  .song-start {
    page-break-before: always;
  }
  .viewer {
    column-count: 2;
    column-gap: 8mm;
  }
}
</style>
</head>

<body>

<div id="serviceOutput" class="viewer"></div>

<!-- LZString -->
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

<script>
/* ===============================
   CORE HELPERS (ISOLATED)
   =============================== */

function decodeServiceSet() {
  const params = new URLSearchParams(location.search);
  const setParam = params.get('set');
  if (!setParam) return null;

  try {
    const decoded = decodeURIComponent(setParam.replace(/ /g,'+'));
    const json = LZString.decompressFromBase64(decoded);
    const list = JSON.parse(json);
    return Array.isArray(list) ? list : null;
  } catch {
    return null;
  }
}

/* ===============================
   PURE RENDERER
   =============================== */

function renderSongFromCho(choText, serviceKey, globalCapo) {
  // We reuse your existing render logic via a sandbox iframe-like approach:
  // create a temp container, inject cho, render once, extract HTML

  const temp = document.createElement('div');
  temp.style.display = 'none';
  document.body.appendChild(temp);

  temp.innerHTML = `
    <textarea id="__src">${choText}</textarea>
    <div id="__out" class="viewer"></div>
  `;

  // Minimal transpose
  const src = temp.querySelector('#__src').value;
  const out = temp.querySelector('#__out');

  // NOTE: This assumes your shared render logic is available globally
  // If your renderer lives in a shared JS file, this will still work.

  window.__SERVICE_RENDER__({
    source: src,
    output: out,
    key: serviceKey,
    capo: globalCapo
  });

  const html = out.innerHTML;
  temp.remove();
  return html;
}

/* ===============================
   SERVICE SET RENDER
   =============================== */

function renderServiceSet(list) {
  const root = document.getElementById('serviceOutput');
  root.innerHTML = '';

  const globalCapo = 0; // future-proof, pedal-ready

  list.forEach((song, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'song-start';
    wrap.innerHTML = renderSongFromCho(song.cho, song.serviceKey, globalCapo);
    root.appendChild(wrap);
  });
}

/* ===============================
   INIT
   =============================== */

(function init(){
  const set = decodeServiceSet();

  if (!set || !set.length) {
    document.getElementById('serviceOutput').innerHTML =
      '<p style="text-align:center;color:#888">No service loaded.</p>';
    return;
  }

  renderServiceSet(set);
})();
</script>

</body>
</html>
